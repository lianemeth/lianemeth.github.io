{"componentChunkName":"component---src-templates-blog-post-js","path":"/high-signal-application-logging/","result":{"data":{"site":{"siteMetadata":{"title":"Lia Nemeth"}},"markdownRemark":{"id":"a5f012ba-d375-5a6e-9071-1f98c762d095","excerpt":"Application logging is often put aside as lower priority. It is rare to see applications that treat logging as a first class element of their architecture, but…","html":"<p>Application logging is often put aside as lower priority. It is rare to see applications that treat logging as a first class element of their architecture, but logging done right can be a powerful tool on increasing the visibility of live environments. Good quality logs play a crucial role in creating alerts and visualizations. If your logs are informative and clear, it becomes easy to use them with tools for creating valuable dashboards. Tools such as <em>ELK</em>, <em>Splunk</em> or <em>Datadog</em> will easily allow you to do this,  but this is a topic I can expand on in another blog post. Likewise, high signal logs can translate into high signal alerts that inform you about abnormal application behavior.</p>\n<p>I consider logging to be essential for my workflow, but informative logs are also a key component on attack repudiation. I learned it from the  threat modelling technique <a href=\"https://en.wikipedia.org/wiki/STRIDE_(security)\">STRIDE</a> which is a famous mnemonic that lists six categories of threats. The <strong>R</strong> stands for repudiation, and it means the ability to assess that something has happened and what it can be done to fix it. For instance, a user can perform some sort of malicious or fraudulent activity. If this information is not logged somewhere, the application owner won’t be able to react, and might even entirely miss it.</p>\n<h2>Formatting</h2>\n<p>Logs should always use machine readable formats. This will allow the application to use a log management tool to its full potential. </p>\n<p>Being able to aggregate logs, and search them by common keys will make it easier to scale application monitoring to multiple servers and services. </p>\n<p>My favorite format for logging is <strong>JSON</strong>, while it is not the best for human readability, it’s supported in all log management services. </p>\n<p>This example show how JSON logging works on Python:</p>\n<h3>JSON logger</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> logging\n<span class=\"token keyword\">import</span> time\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">LogEncoder</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>JSONEncoder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">default</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token builtin\">set</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token builtin\">tuple</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default<span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JsonLogger</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>kwargs <span class=\"token operator\">=</span> kwargs\n        <span class=\"token comment\"># hard-coded fields can be configured here</span>\n        self<span class=\"token punctuation\">.</span>kwargs<span class=\"token punctuation\">[</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> message\n        self<span class=\"token punctuation\">.</span>kwargs<span class=\"token punctuation\">[</span><span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__str__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> LogEncoder<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>kwargs<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">example</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    logging<span class=\"token punctuation\">.</span>basicConfig<span class=\"token punctuation\">(</span>level<span class=\"token operator\">=</span>logging<span class=\"token punctuation\">.</span>INFO<span class=\"token punctuation\">,</span>\n                        <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">'%(message)s'</span><span class=\"token punctuation\">)</span>\n    logging<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span>JsonLogger<span class=\"token punctuation\">(</span>\n        message<span class=\"token operator\">=</span><span class=\"token string\">'this has happened'</span><span class=\"token punctuation\">,</span>\n        user_id<span class=\"token operator\">=</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span>\n        order_number<span class=\"token operator\">=</span><span class=\"token number\">400</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    example<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Output</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"user_id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_number\"</span><span class=\"token operator\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"this has happened\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1600709474</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you create logging policies where common fields are re-used accross services, you will be able to aggregate them through type and value. Based on the example above, application logs could look this:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"user_id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_number\"</span><span class=\"token operator\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"unpaid\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Order has been created\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1600709474</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/create_order\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span><span class=\"token property\">\"user_id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_number\"</span><span class=\"token operator\">:</span> <span class=\"token number\">400</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"paid\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Order has been succesfully paid\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1600709480</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/complete_order\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span><span class=\"token property\">\"user_id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_number\"</span><span class=\"token operator\">:</span> <span class=\"token number\">401</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"unpaid\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Order has been created\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1600709481</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"create_order\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{</span><span class=\"token property\">\"user_id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_number\"</span><span class=\"token operator\">:</span> <span class=\"token number\">401</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"order_status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"failed\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Card has been declined\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1600709487</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"complete_order\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Where we can distinguish a machine readable user history: <code class=\"language-text\">User 12</code> has made two orders in a short timespan, <code class=\"language-text\">order 400</code> has been completed but <code class=\"language-text\">order 401</code> had failed because the card was declined.</p>\n<p>On a log aggregation system, we can easily query this information. For instance, in <em>Datadog</em> the logs above could be queried such as\n<code class=\"language-text\">@order_status:failed AND @path:complete_order</code>\nand that could be used to verify how often orders are having their payment declined.</p>\n<p>The key information for the application should have its own fields, not just in the body of the message. Common fields should be agreed upon between all of the developers of the system, so they can be reused by multiple services or libraries. Documentation around these fields should be made available.</p>\n<h2>Context</h2>\n<p>High signal logging can be obtained if you strive for low volume of highly informative log messages.\nVerbosity is not an issue. That being said, it shouldn’t be through the <strong>amount</strong> of messages that get logged, but on <strong>how much information</strong> each of these messages contains. Verbosity stops being an issue if it’s easy to select only the relevant information from the group of logs. Good formatting and proper use of log levelling helps on that. I will explain levelling on the next section.</p>\n<p>Each message should include the maximum context possible, without including personal or sensitive information. Examples of relevant information can be ids of the database, status code, endpoints, HTTP methods, state, etc. Once context is added on their own fields, repeated patterns can be identified, and made into their own fields into the log format structure.</p>\n<p><em>pro-tip</em>: have certain internal classes and objects have their own logger encoders that expose only the relevant information. For instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>something<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">def</span> <span class=\"token function\">log_encode</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token string\">'user_id'</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n              <span class=\"token string\">'user_status'</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">.</span>status\n              <span class=\"token punctuation\">}</span></code></pre></div>\n<p>This shows a class where the objects can be passed to the logger, which then calls the appropriate method for that object. That would abstract away the responsibility of selecting fields to be logged to the logged objects, making it easy to make changes on their format and on keeping a common pattern accross all log data.</p>\n<h2>Levels</h2>\n<p>Knowing when to use the correct log levels on an application can make the difference between noisy logs that often get ignored vs. informative concise logs that can easily be leveraged to increase application observability. </p>\n<h4>Debug</h4>\n<p>Information that is useful for developers and testers, but would be too verbose in a production scenario. This can be more verbose than the usual application logging, but production environments should be configured to supress these.</p>\n<h4>Info</h4>\n<p>Information about succesfull operations that has happened in the system, should be very informative and full of contextual information. This should be shown in production environments, so it’s important to avoid excessive <code class=\"language-text\">Info</code> level messages. As a rule of thumb, one atomic action should only result in one <code class=\"language-text\">Info</code> level log.</p>\n<h4>Warning</h4>\n<p>Warning messages are unexpected behaviors that do not cause the application to crash or the flow of operations to be interrupted. It should be available in production environments and used with caution.</p>\n<h4>Error</h4>\n<p>An error that caused the operation to stop, but not crash. In a web environment, an action that causes a status code 500 usually should also emit an <code class=\"language-text\">error</code> log.</p>\n<h4>Fatal</h4>\n<p>Actions that cause the application to entirely crash. These should be used only when very relevant. In a web application, these should immediately trigger alerts.</p>\n<h2>Dont’s!</h2>\n<p>It’s important to never log certain types of information. Logging of sensitive or personal identifying information (PII) can result in breaking compliance of certain regulations such as <strong>GDRP</strong>.\nSome of the things that should never be logged are:</p>\n<ul>\n<li>Passport numbers</li>\n<li>Social Security Numbers</li>\n<li>Government issued IDs</li>\n<li>Passwords</li>\n<li>Driver Licenses</li>\n<li>Credit Card Numbers</li>\n<li>Personal addresses</li>\n<li>Telephone numbers</li>\n<li>Personal Addresses</li>\n<li>Public user names</li>\n</ul>\n<p>Anything that can identify a user and their person or a corporation or expose their private information should not be exposed in a log.\nLogs should be kept as anonymous as possible.</p>\n<h2>Conclusion</h2>\n<p>Treating logging as a first class citizen in your application can increase your ability to know what is exactly going on your environments, and to be able to automate alerting and create visualizations based on that.\nThinking on logging early on during development helps create best practices that can be matured with the system.</p>\n<p>I hope this article helps on you treating logging as an essential part of your application and how to leverage that power. Thanks for reading!</p>","frontmatter":{"title":"High Signal Application Logging","date":"September 24, 2020","description":"Logging as a first class element"}}},"pageContext":{"slug":"/high-signal-application-logging/","previous":null,"next":null}}}